
<html>
<head>
<meta charset="UTF-8">
<style>
canvas {
  border-width: medium;
  border-style: solid;
  border-color: black;
}
</style>
<script src="mercator.js"></script>
<script src="matrix2dst.js"></script>
<script src="grid.js"></script>
<script src="util.js"></script>
<script src="debug.js"></script>
<script src="course-ns.js"></script>
<script src="plot-naive.js"></script>
<script src="plot-mercator.js"></script>
<script src="planar.js"></script>
</head>
<body onload="myOnLoad()">
<h1>Mercator Demo</h1>
<canvas id="canvas0" width="800" height="600"></canvas>
<canvas id="canvas1" width="800" height="600"></canvas>
<pre id="preDebug"></pre>
<script>
let sf = JSON.stringify;
let debug = Debug.createFunction("preDebug", true, 40);

function App() {
  this.canvases = [];
  this.plots = [];
  // state: one of { "clear", "naiveP0", "naiveP1", "mercatorP0", "mercatorP1" }
  // I will used "armed" to refer to any of the non-clear states.
  this.state = "clear";
}
App.prototype = {
  init : function() {
  
    for(var i of [0,1]) {
      var canvas = document.getElementById("canvas"+i);
      if(!canvas.getContext) {
        alert(`Error: no canvas.getContext`);
        return;
      }
      this.canvases.push(canvas);
      var plot = i==0 ? new PlotMercator(canvas) : new PlotNaive(canvas);
      if(i==1) {
        let phi0=0, theta0=0, phi1=30, theta1=60;
        plot.addCourse(new CourseNS(phi0,theta0,phi1,theta1,plot.wld2cv,plot.cv2wld));
      }
      this.plots.push(plot);
    }

    var body = document.getElementsByTagName("body")[0];
    body.addEventListener("mousedown", e => app.handleMouseEvent(e));
    body.addEventListener("mouseup", e => app.handleMouseEvent(e));
    body.addEventListener("mousemove", e => app.handleMouseEvent(e));
  },
  draw : function() {
    for(plot of this.plots) {
      plot.draw();
    }
  },
  handleMouseEvent: function(e) {
    var {state} = this;
    // A Finite State Automaton implemented using if-else .
    if("mousedown" == e.type) {
      if(state == "clear") {
        this.handleClearMouseDown(e);
      }
      else {
        debug("mousedown while armed: ignore.");
      }
    }
    else if("mouseup" == e.type) {
      if(state == "clear") {
        debug("mouseup in state clear");
      }
      else {
        this.handleArmedMouseUp(e);
      }
    }
    else if("mousemove" == e.type) {
      if(state == "clear") {
      }
      else if(state == "naiveP0" || state == "naiveP1") {
        this.handleNaiveMouseMove(e);
      }
      else if(state == "mercatorP0" || state == "mercatorP1") {
        this.handleMercatorMouseMove(e);
      }
    }
  },
  handleClearMouseDown(e) {
    if(e.target == this.canvases[1]) {
      let canvas = this.canvases[1];
      let plot = this.plots[1];
      let hits = this.plots[1].hit(e);
      if(hits.length>0) {
        debug(sf(hits));
      }
    }
  },
  handleArmedMouseDown(e) {
    // TODO
  },
  handleNaiveMouseMove(e) {
    // TODO
  },
  handleMercatorMouseMove(e) {
    // TODO
  }
}

function myOnLoad() {
  window.app = new App();
  var app = window.app;
  app.init();
  app.draw();
}
</script>
</body>
</html>

